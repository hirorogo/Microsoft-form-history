name: Build Test

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

jobs:
  test-build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: ['20.11.0']
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run TypeScript check
      run: npx tsc --noEmit
      
    - name: Build extension
      run: npm run build
      
    - name: Validate manifest.json
      run: |
        if [ ! -f "dist/manifest.json" ]; then
          echo "Error: manifest.json not found in dist/"
          exit 1
        fi
        echo "‚úÖ manifest.json exists"
        
        # Node.js„ÅßJSONÂΩ¢Âºè„Å®ÂÜÖÂÆπ„ÅÆÊ§úË®º
        node -e "
          const fs = require('fs');
          
          try {
            const manifest = JSON.parse(fs.readFileSync('dist/manifest.json', 'utf8'));
            console.log('‚úÖ manifest.json is valid JSON');
            
            if (manifest.manifest_version !== 3) {
              console.error(\`Error: manifest_version should be 3, got \${manifest.manifest_version}\`);
              process.exit(1);
            }
            console.log('‚úÖ manifest_version is correct');
            
            if (manifest.name !== 'Microsoft Form History') {
              console.error(\`Error: name field is incorrect: \${manifest.name}\`);
              process.exit(1);
            }
            console.log('‚úÖ name field is correct');
            
            console.log('üìã Manifest validation completed successfully');
          } catch (error) {
            console.error('Error validating manifest.json:', error.message);
            process.exit(1);
          }
        "
        
    - name: Check required files
      run: |
        echo "Checking required files in dist/..."
        REQUIRED_FILES=(
          "manifest.json"
          "logo.png"
          "src/popup/index.html"
          "src/web-accessible-resources.js"
        )
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "dist/$file" ]; then
            echo "‚ùå Required file missing: $file"
            exit 1
          else
            echo "‚úÖ Found: $file"
          fi
        done
        
    - name: Check zip file creation
      run: |
        if [ ! -f release/crx-microsoft-form-history-*.zip ]; then
          echo "Error: Zip file not created"
          ls -la release/
          exit 1
        fi
        echo "‚úÖ Zip file created successfully"
        
        # ZIPÂÜÖÂÆπ„ÅÆÁ¢∫Ë™ç
        ZIP_FILE=$(ls release/crx-microsoft-form-history-*.zip | head -1)
        echo "Checking contents of $ZIP_FILE..."
        unzip -l "$ZIP_FILE"
        
    - name: Archive build results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-results-node-${{ matrix.node-version }}
        path: |
          dist/
          release/
        retention-days: 7
